## Overview of ISSU

The In Service Software Upgrade (ISSU) pipeline is used to deploy the AOC application (with optional deployments of RBAC, CRDs, and Pre-requisites) and perform a software upgrade as simulated traffic is running. 

The ISSU is configurable with the option of deploying release versions of AOC (22.12, 22.12.01 etc.) as well as custom deployments with application versions that differ from official releases. Testcases are specified via config. Currently Gy traffic tests are generated by the Binaryloader pod using the parameters found in the testcase config file. Parameters such as test run time and TPS are examples of configurable elements. The applications to be upgraded can also be configured as well as their upgrade version.

The [ISSU Test Pipeline](https://sba-jenkins.openet.com/job/ECS/job/AOC-ISSU/job/issu-test/) is where an ISSU test will be executed from and the [ISSU Test Repo](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse) contains all relevant configuration files and scripts.

![ISSU Test Diagram](../images/diagram.png)

### Configuration
There are three configurable elements in an ISSU Test
1. Deploying
2. Upgrading
3. Testcase & Metrics

### Deploying
ISSU Testing uses [MPDK](https://bitbucket.openet.com/projects/AD/repos/openet-aoc-udocs/browse) for deployment. The pipeline can deploy RBAC, CRDs, Pre-requisites and the application itself. 

### Upgrading
After the application has been deployed via MPDK, an upgrade is executed using a user-created testcase [file](./03-creating-a-testcase-file.md). A default [upgrade.sh](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/scripts/upgrade.sh) script exists for a default upgrade, but a custom upgrade script can be created in the ISSU Test repository and specified in the testcase file on a per-chart basis if this default upgrade script is not sufficient

### Testcase & Metrics 
To simulate the application in service, traffic is ran in the test environment. Currently the only traffic type supported by the testcase file is Gy traffic.

# Repository Structure
<img src="../images/repo-structure.png"  width="50%" height="50%">

The ISSU Test repository contains all the configuration necessary to run an In Service Upgrade.

### config
The [config](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/config) directory contains two directories: deploymentConfig and testcases.

### config/deploymentConfig
 The [deploymentConfig](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/config/deploymentConfig) directory largely contains default/placeholder config aligned with the AOC ISSU EDs for deployment specific config such as namespaces, release names, etc, and the names of credentials in Jenkins for kubernetes cluster. Typically these files will not need to be updated unless a new chart has been added to the AOC deployment, in which case [defaults.yaml](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/config/deploymentConfig/defaults.yaml) requires an update, or if cluster credentials in Jenkins are updated then [kube-tokens.yaml](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/config/deploymentConfig/kube-tokens.yaml) must be updated.

 ### config/testcases
 The [testcase](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/config/testcases) directory contains the config specifying which applications will be upgraded and to what version. There are standard testcase files in this directory which can be used as a reference for creating new testcase files which will be required for any new ISSU test. Instructions can be found [here](./03-creating-a-testcase-file.md)

 ### Jenkins
 The [jenkins](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/jenkins) directory contains the Jenkinsfile which holds the configuration for the ISSU-Test Jenkins job. This is the main orchestration pipeline used to execute the deployment, run the traffic, collect required metics, and perform the upgrade specified in the provided testcase file. Deployment is handled by MPDK jobs which are called downstream. Instructions on running this Jenkins job can be found [here](./05-running-the-test.md)

 ### scripts
 The [scripts](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/scripts) directory contains shell and groovy scripts used during the ISSU test. Custom upgrade scripts used by the ISSU Test job should be added here.
 
 ### scripts/config
 The [config](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/scripts/config) directory contains a groovy script called issu-utils.groovy which has functions that are called by the ISSU Jenkinsfile. Most users will not need to interact with this file but if a new function needs to be added to the Jenkins run the new function should be created in this file.

 ### scripts/metrics
 The [metrics](https://bitbucket.openet.com/projects/AI/repos/issu-test/browse/scripts/metrics) directory contains the create_csv.sh script which creates the test report output.

## Create root-ed:

This is an environment descriptor that describes a specific AOC installation. It is an MPDK pipeline. Root ED could be written to deploy upgrade all or parts of AOC. The Root ED contains installation specific parameters and is typically managed in a git repo. Root ED can deploy helm charts, Sub EDs or a combination of both.

**Root ED Contents**
A repository for a Root ED project may contain the following:
- tokensReplacer.yaml
- env-descriptor.yaml
- namespaceValues
- profileValues
- scripts
- jenkins/Jenkinsfile.groovy that call Jenkins Deployment Module.

#  Token Replacer:

See the following section of MPDK documentaion further information on Token Replacer: 

https://msnext-master.corp.amdocs.com/pub/doc/platform/ms360-platform/ms360-platform-1.41.0/deployment/30-tools/35-token-replacer.html


## Sample TokensReplacer.yaml 

The following snippet is from a Root ED to deploy AOC

```
# required content 
enable: true
settings:
  tokenSign: ^
  listOfFiles:
    - ${WORKSPACE}/env/${ENV_NAME}/env-descriptor.yaml
  listOfFolders:
    - ${WORKSPACE}/env/${ENV_NAME}/profileValues
    - ${WORKSPACE}/env/${ENV_NAME}/namespaceValues

# start of Tokens
tokens:
  TOKEN_ENV_NAME: ${ENV_NAME}

  # Tokens related to Chart Versions
  RSYNCD_VERSION: 2.10.0

  # Tokens related to imported Sub-ed Versions 
  AOC_PROV_ED_VERSION: 1.0.0-SNAPSHOT
  AOC_OCRT_ED_VERSION: 1.0.0-SNAPSHOT
  AOC_UDSF_ED_VERSION: 1.0.0-SNAPSHOT
  AOC_CHARGING_ED_VERSION: 1.0.0-SNAPSHOT
```


##  env-descriptor:

The following `env-descriptor.yaml` snippet demonstrates 

* import and deployment of Sub EDs (which include ocrt, charging, provisioning and udsf services)
* import and deployment of Rsyncd Chart (deployment is done in a pre-deployment step ahead of other services
* exclude diameter services in the charting Sub ED (DRB & Sigm services are not required in a `5G` deployment)
* creates namespaces (dependent on runCondition)
* calls post deployment Jenkins groovy to run tests

**Sample env-descriptor.yaml**
```
apiVersion: descriptors.amdocs.com/v1beta1
kind: Environment
metadata:
  name: aoc-5g
spec:
  releaseVersion: 1.0.0
  env:
    type: k8s
    envMode: prod
  profiles:
    resourceProfile: development
  bulkDeploymentSize: 10
  helmVersion: 3.8.0
  helmTimeout: 360
  helmHistoryMax: 2
  helmAdditionalOptions:
    wait : true
  conventionOverConfiguration: true
  throwOnConditionKeyMissing : true
  importED:
    envDescriptors:
    - name: aoc-ocrt-ed
      configuration:
        uri: com.openet.aoc:ocrt-ed:tar.gz:^AOC_OCRT_ED_VERSION^
        repository: ^TOKEN_ARTIFACTORY_BASEURL^
        repositoryCredId: ^HELM_REPO_CREDENTIAL_ID^
    - name: aoc-charging-ed
      configuration:
        uri: com.openet.aoc:charging-ed:tar.gz:^AOC_CHARGING_ED_VERSION^
        repository: ^TOKEN_ARTIFACTORY_BASEURL^
        repositoryCredId: ^HELM_REPO_CREDENTIAL_ID^
      exclude:
        namespaces:
        - name: ^TOKEN_NAMESPACE_CHARGING^
          domains:
          - name: charging-diameter-services
    - name: aoc-prov-ed
      configuration:
        uri: com.openet.aoc:provisioning-ed:tar.gz:^AOC_PROV_ED_VERSION^
        repository: ^TOKEN_ARTIFACTORY_BASEURL^
        repositoryCredId: ^HELM_REPO_CREDENTIAL_ID^
    - name: aoc-udsf-ed
      configuration:
        uri: com.openet.aoc:udsf-ed:tar.gz:^AOC_UDSF_ED_VERSION^
        repository: ^TOKEN_ARTIFACTORY_BASEURL^
        repositoryCredId: ^HELM_REPO_CREDENTIAL_ID^
  namespaces:
  - name: ^TOKEN_NAMESPACE_RSYNCD^
    type: rsyncd
    charts:
      - chartName: rsyncd
        releaseName: rsyncd
        helmRepo: ^TOKEN_ARTIFACTORY_HELM_BASEURL^
        deploymentPhase: step
        repositoryCredId: ^HELM_REPO_CREDENTIAL_ID^
        type: helm-microservice
        version: ^RSYNCD_VERSION^
  - name: ^TOKEN_NAMESPACE_PROVISIONING^
    type: provisioning
    includeNamespaceED:
    - name: aoc-prov-ed
      namespace: ^TOKEN_NAMESPACE_PROVISIONING^
  - name: ^TOKEN_NAMESPACE_CHARGING^
    type: charging
    includeNamespaceED:
    - name: aoc-charging-ed
      namespace: ^TOKEN_NAMESPACE_CHARGING^
  - name: ^TOKEN_NAMESPACE_OCRT^
    type: ocrt
    includeNamespaceED:
    - name: aoc-ocrt-ed
      namespace: ^TOKEN_NAMESPACE_OCRT^
  - name: ^TOKEN_NAMESPACE_CHF_UDSF^
    type: udsf-chf
    includeNamespaceED:
    - name: aoc-udsf-ed
      namespace: ^TOKEN_NAMESPACE_CHF_UDSF^
  preDeployment:
    namespaces:
      alreadyCreated: false
      resourceQuata: {}
    stepsConfig:
    - name: workspaceCustomStep
      executionStage: prepare values
      desc: prepare values file
      throwOnFailure: true
      stepParams:
          credentialName: jenkins-openstack
          keyName: customGitClientSshSecret
          targetPath: env/aoc-5g/namespaceValues/rsyncd/charts/rsyncd/rsyncd/999_private-key-values.yaml
          script: "vars/credentialAsValues.groovy"
      runConditions:
      - ed.spec.env.installType: ["install"]
## create namespace
    - name: createNamespace
      executionStage: Create Namespace
      throwOnFailure: true
      stepParams: {}
      scmSkip: true
## deploy rsyncd
    - name: genericDeploymentStep
      executionStage: Deploy Rsyncd
      throwOnFailure: true
      stepParams:
        releaseName: rsyncd
## Main Deployment steps executed between pre & postDeployment
  postDeployment:
    notification:
      dl: nonexist@nomail.com
    stepsConfig:
    - name: deployEnvDesc
      stepParams: {}
    - name: reportAndNotify
      stepParams: {}
```

# Values and Profiles:

Root ED will almost always require some values overrides. 
See the following section of MPDK documentaion for further information
https://msnext-master.corp.amdocs.com/pub/doc/platform/ms360-platform/ms360-platform-1.41.0/deployment/05-basic-concepts/15-env-descriptor.html#using-namespace-level-values

## namespaceValues file structure convention

The values folder contains all the environment specific configuration that is needed to condition the environment. These are the same values files that would typically be used when running a helm install or upgrade command.
Technically, our environment is a set of helm charts. But from a business context, these helm charts can be categorized as products and/or domains within those products. The example folder structure shown below highlights that aspect. We can segregate our values files for the respective helm charts according to their respective product and domain affinity.
If there is no such affinity then those values files can go into the chart folder. The same helm chart might be used in different helm releases for which we can have individual release folders.
Once the segregation logic as per above is done, the `convention over configuration` feature of MPDK kicks in which applies the respective values files as per the structure defined below.

```
namespaceValues/
├── charts
│   └── <chartName>
│       └── <releaseName>
│           └── values.yaml
└── products
    └── <productName>
        └── <domainName>
            └── <chartName>
                └── values.yaml
```

Values file in AOC MPDK repositories are designed for specific chart, therefore it needs to be put at chart level. If needed, values file could be put at higher level of directory (I.e. product or domain level) to apply Helm values parameters at the corresponding level covering multiple assembly charts.

*All files must have `*values.yaml` as suffix.*

For more info on this feature kindly refer to: [MPDK Deploy convention-over-configuration](https://msnext-master.corp.amdocs.com/pub/doc/platform/ms360-platform/ms360-platform-1.41.0/deployment/05-basic-concepts/15-env-descriptor.html#using-convention-over-configuration)


## Profiles
Profiles are the feature that allow you to use a custom set of values in MPDK deploy. Applying custom values files to domains/charts during installation. 
To use profiles you must set the `conventionOverConfiguration` property to `true` . You must add a `profiles` section to your environment descriptor file and provide the `key:value` parameters that you want to use in your profile.  

### Profiles
Create a subfolder named profileValues in your environment folder. Then create a profile key value within that folder. For options under that profile then add another key value folder. 

```
profileValues
└── profile-name
    ├── profile-key-1
    │   ├── charts
    │   │   └── chartName
    │   │       └── releaseName
    │   │           └── values.yaml
    │   ├── products
    │   │   └── productName
    │   │       └── domainName
    │   │           └── values.yaml
    │   └── values.yaml
    └── profile-key-2
        ├── charts
        │   └── chartName
        │       └── releaseName
        │           └── values.yaml
        ├── products
        │   └── productName
        │       └── domainName
        │           └── values.yaml
        └── values.yaml

```

Usage of profiles within environment descriptor with profile above.
```
apiVersion: descriptors.amdocs.com/v1beta1
kind: Environment
metadata:
  name: aoc-5g
spec:
  releaseVersion: 1.0.0
  env:
    type: k8s
    envMode: prod
    authType: serviceaccount
  profiles:
    tls: enabled
    resourceProfile: production
    option: disabled
  conventionOverConfiguration: true
```


# Upgrade activity

### Pre-Requisites :
Customer does have their own root-ed. 


### MR Upgrade:  
- For MR Upgrade, Need to Update Sub ED versions in `tokenReplacer.yaml` file.
     ```
     tokens:
       TOKEN_ENV_NAME: ${ENV_NAME}
     
       # Tokens related to Chart Versions
       RSYNCD_VERSION: 2.10.0
     
       # Tokens related to imported Sub-ed Versions 
       AOC_PROV_ED_VERSION: 1.0.0-SNAPSHOT  <<<<
       AOC_OCRT_ED_VERSION: 1.0.0-SNAPSHOT  <<<<
       AOC_UDSF_ED_VERSION: 1.0.0-SNAPSHOT  <<<<
       AOC_CHARGING_ED_VERSION: 1.0.0-SNAPSHOT <<<<
     ```
- Trigger the Jenkins Root ED Job. 
